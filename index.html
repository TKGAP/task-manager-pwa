<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>付箋付きタスク管理アプリ</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0052cc">
<style>
  body {
    font-family: sans-serif;
    margin:0; padding:0;
    background:#f0f4f8;
  }
  header {
    background:#0052cc;
    color:#fff;
    padding:1rem;
    text-align:center;
    font-size:1.3rem;
  }
  main {
    max-width: 900px;
    margin: auto;
    padding: 1rem;
  }
  /* タブ切替ボタン */
  .tabs {
    display:flex;
    justify-content:center;
    margin-bottom: 1rem;
  }
  .tab-btn {
    padding: 0.5rem 1.5rem;
    margin:0 0.3rem;
    border:none;
    background:#ccc;
    border-radius:4px;
    cursor:pointer;
    font-weight:bold;
  }
  .tab-btn.active {
    background:#0052cc;
    color:#fff;
  }

  /* タスクリスト */
  #taskList {
    display:flex;
    flex-wrap: wrap;
    gap: 0.8rem;
  }

  /* 付箋タスクカード */
  .task-card {
    position: relative;
    background:#fff;
    box-shadow: 0 3px 7px rgba(0,0,0,0.15);
    padding: 1rem 1rem 1rem 2.5rem;
    border-radius: 12px;
    width: 180px;
    min-height: 100px;
    user-select:none;
    transition: background-color 0.3s, opacity 0.3s;
    touch-action: pan-y;
  }
  /* チェック済みは薄く */
  .task-card.done {
    opacity: 0.5;
    text-decoration: line-through;
  }

  /* チェックボックス */
  .task-card input[type=checkbox] {
    position: absolute;
    left: 10px;
    top: 10px;
    width: 18px;
    height: 18px;
  }

  /* 付箋の色バリエーション */
  .color-0 { background:#fffbea; }
  .color-1 { background:#ffebeb; }
  .color-2 { background:#e0ffe0; }
  .color-3 { background:#e0e7ff; }

  /* 付箋形状パターン */
  .shape-0 { border-radius: 12px; box-shadow: 0 3px 7px rgba(0,0,0,0.15); }
  .shape-1 { border-radius: 4px; box-shadow: none; }
  .shape-2 { border-radius: 20px; box-shadow: 0 0 15px rgba(0,0,0,0.1) inset; }

  /* 付箋タイトル */
  .task-title {
    font-weight: bold;
    font-size: 1.1rem;
    margin-bottom: 0.4rem;
  }
  /* メニュー ⋮ ボタン */
  .menu-btn {
    position: absolute;
    top: 8px;
    right: 8px;
    background: transparent;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    user-select:none;
  }

  /* メニュー */
  .menu {
    position: absolute;
    top: 30px;
    right: 8px;
    background: #fff;
    border: 1px solid #ccc;
    box-shadow: 0 2px 7px rgba(0,0,0,0.15);
    border-radius: 6px;
    padding: 6px 8px;
    display: none;
    z-index: 10;
    min-width: 150px;
  }
  .menu.visible {
    display: block;
  }
  .menu button {
    width: 100%;
    border:none;
    background: none;
    padding: 6px 4px;
    text-align: left;
    cursor: pointer;
    font-size: 0.9rem;
  }
  .menu button:hover {
    background: #f0f0f0;
  }
  .menu .delete-btn {
    color: #e53935;
    font-weight: bold;
  }

  /* カレンダーエリア */
  #calendar {
    max-width: 900px;
    margin: auto;
  }
  table.calendar-table {
    border-collapse: collapse;
    width: 100%;
  }
  table.calendar-table th, table.calendar-table td {
    border: 1px solid #ccc;
    width: 14.28%;
    vertical-align: top;
    height: 90px;
    padding: 3px 5px;
    position: relative;
  }
  table.calendar-table th {
    background:#0052cc;
    color:#fff;
  }
  .calendar-date {
    font-weight: bold;
    font-size: 0.9rem;
    margin-bottom: 3px;
  }
  /* カレンダー内タスク表示 */
  .calendar-task {
    background:#e0e7ff;
    border-radius: 6px;
    margin: 2px 0;
    padding: 2px 5px;
    font-size: 0.75rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

</style>
</head>
<body>
<header>付箋付きタスク管理アプリ</header>
<main>
  <div class="tabs">
    <button class="tab-btn active" data-view="list">リスト表示</button>
    <button class="tab-btn" data-view="calendar">カレンダー表示</button>
  </div>

  <section id="listView">
    <button id="addTaskBtn">＋ タスク追加</button>
    <div id="taskList"></div>
  </section>

  <section id="calendarView" style="display:none;">
    <div id="calendar"></div>
  </section>
</main>

<!-- タスク追加モーダル -->
<div id="taskModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; 
  background: rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index: 100;">
  <div style="background:#fff; padding:1rem; border-radius:8px; max-width:350px; width:90%;">
    <h3>タスク追加・編集</h3>
    <form id="taskForm">
      <label>タイトル<br /><input type="text" id="taskTitle" required /></label><br />
      <label>期限<br /><input type="date" id="taskDue" /></label><br />
      <button type="submit">保存</button>
      <button type="button" id="cancelBtn" style="margin-left:1rem;">キャンセル</button>
    </form>
  </div>
</div>

<script>
(() => {
  // ======= データ =======
  let tasks = JSON.parse(localStorage.getItem("tasks")||"[]");
  let editingTaskIndex = null;

  // ======= UI =======
  const tabs = document.querySelectorAll(".tab-btn");
  const listView = document.getElementById("listView");
  const calendarView = document.getElementById("calendarView");
  const taskList = document.getElementById("taskList");
  const calendarDiv = document.getElementById("calendar");
  const addTaskBtn = document.getElementById("addTaskBtn");
  const taskModal = document.getElementById("taskModal");
  const taskForm = document.getElementById("taskForm");
  const taskTitleInput = document.getElementById("taskTitle");
  const taskDueInput = document.getElementById("taskDue");
  const cancelBtn = document.getElementById("cancelBtn");

  // タブ切替
  tabs.forEach(tab => {
    tab.addEventListener("click", () => {
      tabs.forEach(b => b.classList.remove("active"));
      tab.classList.add("active");
      if(tab.dataset.view === "list") {
        listView.style.display = "";
        calendarView.style.display = "none";
        renderTasks();
      } else {
        listView.style.display = "none";
        calendarView.style.display = "";
        renderCalendar();
      }
    });
  });

  // 付箋色・形・文字サイズ定義
  const colors = ["color-0","color-1","color-2","color-3"];
  const shapes = ["shape-0","shape-1","shape-2"];
  const fontSizes = ["1rem","1.2rem","1.5rem"];

  // --- タスク描画 ---
  function renderTasks() {
    taskList.innerHTML = "";
    tasks.forEach((task,i) => {
      const card = document.createElement("div");
      card.className = `task-card ${colors[task.color]||colors[0]} ${shapes[task.shape]||shapes[0]}`;
      if(task.done) card.classList.add("done");
      card.style.fontSize = fontSizes[task.fontSize]||fontSizes[0];
      card.setAttribute("data-index", i);

      // チェックボックス
      const checkbox = document.createElement("input");
      checkbox.type = "checkbox";
      checkbox.checked = task.done;
      checkbox.addEventListener("change", () => {
        tasks[i].done = checkbox.checked;
        saveTasks();
        renderTasks();
      });
      card.appendChild(checkbox);

      // タイトル
      const title = document.createElement("div");
      title.className = "task-title";
      title.textContent = task.title;
      card.appendChild(title);

      // メニュー ⋮ ボタン
      const menuBtn = document.createElement("button");
      menuBtn.className = "menu-btn";
      menuBtn.textContent = "⋮";
      card.appendChild(menuBtn);

      // メニュー作成
      const menu = document.createElement("div");
      menu.className = "menu";
      menu.innerHTML = `
        <button class="font-small">文字サイズ 小</button>
        <button class="font-medium">文字サイズ 中</button>
        <button class="font-large">文字サイズ 大</button>
        <button class="shape-0">形状 角丸</button>
        <button class="shape-1">形状 角あり</button>
        <button class="shape-2">形状 影あり</button>
        <button class="delete-btn">🗑️ 削除</button>
      `;
      card.appendChild(menu);

      // メニュー表示切替
      menuBtn.addEventListener("click", e => {
        e.stopPropagation();
        document.querySelectorAll(".menu").forEach(m => {
          if(m!==menu) m.classList.remove("visible");
        });
        menu.classList.toggle("visible");
      });

      // メニュー内ボタン処理
      menu.querySelector(".font-small").addEventListener("click", () => {
        tasks[i].fontSize = 0;
        saveTasks();
        renderTasks();
      });
      menu.querySelector(".font-medium").addEventListener("click", () => {
        tasks[i].fontSize = 1;
        saveTasks();
        renderTasks();
      });
      menu.querySelector(".font-large").addEventListener("click", () => {
        tasks[i].fontSize = 2;
        saveTasks();
        renderTasks();
      });
      menu.querySelector(".shape-0").addEventListener("click", () => {
        tasks[i].shape = 0;
        saveTasks();
        renderTasks();
      });
      menu.querySelector(".shape-1").addEventListener("click", () => {
        tasks[i].shape = 1;
        saveTasks();
        renderTasks();
      });
      menu.querySelector(".shape-2").addEventListener("click", () => {
        tasks[i].shape = 2;
        saveTasks();
        renderTasks();
      });
      menu.querySelector(".delete-btn").addEventListener("click", () => {
        tasks.splice(i,1);
        saveTasks();
        renderTasks();
      });

      // 色変更(スワイプ的に簡易で左右で色変える)
      let startX = null;
      card.addEventListener("touchstart", e => {
        startX = e.changedTouches[0].clientX;
      });
      card.addEventListener("touchend", e => {
        if(startX === null) return;
        let endX = e.changedTouches[0].clientX;
        let diff = endX - startX;
        if(Math.abs(diff) > 30){
          let currentColor = task.color || 0;
          if(diff > 0) {
            // 右スワイプで色1つ進む
            tasks[i].color = (currentColor + 1) % colors.length;
          } else {
            // 左スワイプで色1つ戻る
            tasks[i].color = (currentColor + colors.length - 1) % colors.length;
          }
          saveTasks();
          renderTasks();
        }
        startX = null;
      });

      taskList.appendChild(card);
    });
    // メニュー閉じる
    document.body.addEventListener("click", () => {
      document.querySelectorAll(".menu").forEach(m => m.classList.remove("visible"));
    });
  }

  // --- カレンダー描画 ---
  function renderCalendar() {
    calendarDiv.innerHTML = "";
    const now = new Date();
    const year = now.getFullYear();
    const month = now.getMonth();
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const startWeekDay = firstDay.getDay();
    const totalDays = lastDay.getDate();

    const table = document.createElement("table");
    table.className = "calendar-table";
    const thead = document.createElement("thead");
    const trHead = document.createElement("tr");
    ["日","月","火","水","木","金","土"].forEach(d => {
      const th = document.createElement("th");
      th.textContent = d;
      trHead.appendChild(th);
    });
    thead.appendChild(trHead);
    table.appendChild(thead);

    const tbody = document.createElement("tbody");
    let dayCount = 1;
    for(let i=0; i<6; i++){
      const tr = document.createElement("tr");
      for(let j=0; j<7; j++){
        const td = document.createElement("td");
        if(i===0 && j < startWeekDay){
          td.textContent = "";
        } else if(dayCount > totalDays){
          td.textContent = "";
        } else {
          const dateDiv = document.createElement("div");
          dateDiv.className = "calendar-date";
          dateDiv.textContent = dayCount;
          td.appendChild(dateDiv);

          // その日付のタスクを表示
          const dayStr = `${year}-${String(month+1).padStart(2,"0")}-${String(dayCount).padStart(2,"0")}`;
          tasks.forEach(task => {
            if(task.due === dayStr){
              const taskDiv = document.createElement("div");
              taskDiv.className = "calendar-task";
              taskDiv.textContent = task.title;
              td.appendChild(taskDiv);
            }
          });

          dayCount++;
        }
        tr.appendChild(td);
      }
      tbody.appendChild(tr);
    }
    table.appendChild(tbody);
    calendarDiv.appendChild(table);
  }

  // ======= 保存
  // ======= 保存 =======
  function saveTasks() {
    localStorage.setItem("tasks", JSON.stringify(tasks));
  }

  // ======= モーダル表示 =======
  function openModal(editIndex = null) {
    editingTaskIndex = editIndex;
    if(editIndex !== null){
      const t = tasks[editIndex];
      taskTitleInput.value = t.title || "";
      taskDueInput.value = t.due || "";
    } else {
      taskTitleInput.value = "";
      taskDueInput.value = "";
    }
    taskModal.style.display = "flex";
  }

  // ======= モーダル非表示 =======
  function closeModal() {
    taskModal.style.display = "none";
  }

  // ======= タスク追加ボタン =======
  addTaskBtn.addEventListener("click", () => {
    openModal();
  });

  // ======= キャンセルボタン =======
  cancelBtn.addEventListener("click", () => {
    closeModal();
  });

  // ======= フォーム送信（タスク保存） =======
  taskForm.addEventListener("submit", e => {
    e.preventDefault();
    const title = taskTitleInput.value.trim();
    const due = taskDueInput.value;

    if(!title){
      alert("タイトルは必須です");
      return;
    }

    if(editingTaskIndex !== null){
      // 編集モード
      tasks[editingTaskIndex].title = title;
      tasks[editingTaskIndex].due = due;
    } else {
      // 新規追加
      tasks.push({
        title,
        due,
        done: false,
        color: 0,
        shape: 0,
        fontSize: 0,
      });
    }
    saveTasks();
    closeModal();
    renderTasks();
    if(document.querySelector(".tab-btn.active").dataset.view === "calendar"){
      renderCalendar();
    }
  });

  // 初期表示
  renderTasks();

  // service worker登録（あれば）
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('service-worker.js').catch(()=>{});
  }
})();
</script>

</body>
</html>