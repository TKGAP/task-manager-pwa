<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ä»˜ç®‹ä»˜ãã‚¿ã‚¹ã‚¯ç®¡ç†ã‚¢ãƒ—ãƒª</title>
<style>
  body { font-family: sans-serif; margin:0; padding:0; background:#f0f4f8; }
  header { background:#0052cc; color:#fff; padding:1rem; text-align:center; font-size:1.3rem; }
  main { max-width: 900px; margin: auto; padding: 1rem; }

  .tabs { display:flex; justify-content:center; margin-bottom: 1rem; }
  .tab-btn { padding: 0.5rem 1.5rem; margin:0 0.3rem; border:none; background:#ccc; border-radius:4px; cursor:pointer; font-weight:bold; }
  .tab-btn.active { background:#0052cc; color:#fff; }

  #taskList { display:flex; flex-wrap: wrap; gap: 0.8rem; }

  .task-card {
    position: relative; background:#fff; padding: 1rem 1rem 1rem 2.5rem;
    border-radius: 12px; width: 180px; min-height: 100px; box-shadow: 0 3px 7px rgba(0,0,0,0.15);
    user-select:none; transition: background-color 0.3s, opacity 0.3s;
  }
  .task-card.done { opacity: 0.5; text-decoration: line-through; }

  .task-card input[type=checkbox] {
    position: absolute; left: 10px; top: 10px; width: 18px; height: 18px;
  }

  .color-0 { background:#fffbea; }
  .color-1 { background:#ffebeb; }
  .color-2 { background:#e0ffe0; }
  .color-3 { background:#e0e7ff; }

  .shape-0 { border-radius: 12px; box-shadow: 0 3px 7px rgba(0,0,0,0.15); }
  .shape-1 { border-radius: 4px; box-shadow: none; }
  .shape-2 { border-radius: 20px; box-shadow: 0 0 15px rgba(0,0,0,0.1) inset; }

  .task-title { font-weight: bold; font-size: 1.1rem; margin-bottom: 0.4rem; }
  .task-tag { font-size: 0.8rem; background:#ddd; padding: 2px 6px; border-radius: 6px; display:inline-block; }

  .menu-btn {
    position: absolute; top: 8px; right: 8px; background: transparent; border: none;
    font-size: 1.5rem; cursor: pointer;
  }
  .menu {
    position: absolute; top: 30px; right: 8px; background: #fff; border: 1px solid #ccc;
    box-shadow: 0 2px 7px rgba(0,0,0,0.15); border-radius: 6px; padding: 6px 8px;
    display: none; z-index: 10; min-width: 150px;
  }
  .menu.visible { display: block; }
  .menu button { width: 100%; border:none; background: none; padding: 6px 4px; text-align: left; cursor: pointer; font-size: 0.9rem; }
  .menu button:hover { background: #f0f0f0; }
  .menu .delete-btn { color: #e53935; font-weight: bold; }

  #calendar { max-width: 900px; margin: auto; }
  table.calendar-table { border-collapse: collapse; width: 100%; }
  table.calendar-table th, table.calendar-table td { border: 1px solid #ccc; width: 14.28%; vertical-align: top; height: 90px; padding: 3px 5px; }
  table.calendar-table th { background:#0052cc; color:#fff; }
  .calendar-date { font-weight: bold; font-size: 0.9rem; }
  .calendar-task { background:#e0e7ff; border-radius: 6px; margin: 2px 0; padding: 2px 5px; font-size: 0.75rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

  #tagFilters { margin-bottom: 10px; }
  #tagFilters button { margin: 2px; padding: 4px 8px; cursor: pointer; }
</style>
</head>
<body>
<header>ä»˜ç®‹ä»˜ãã‚¿ã‚¹ã‚¯ç®¡ç†ã‚¢ãƒ—ãƒª</header>
<main>
  <div class="tabs">
    <button class="tab-btn active" data-view="list">ãƒªã‚¹ãƒˆè¡¨ç¤º</button>
    <button class="tab-btn" data-view="calendar">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ç¤º</button>
  </div>

  <div id="tagFilters"></div>

  <section id="listView">
    <button id="addTaskBtn">ï¼‹ ã‚¿ã‚¹ã‚¯è¿½åŠ </button>
    <div id="taskList"></div>
  </section>

  <section id="calendarView" style="display:none;">
    <div id="calendar"></div>
  </section>
</main>

<div id="taskModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
  background: rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index: 100;">
  <div style="background:#fff; padding:1rem; border-radius:8px; max-width:350px; width:90%;">
    <h3>ã‚¿ã‚¹ã‚¯è¿½åŠ ãƒ»ç·¨é›†</h3>
    <form id="taskForm">
      <label>ã‚¿ã‚¤ãƒˆãƒ«<br /><input type="text" id="taskTitle" required /></label><br />
      <label>ã‚¿ã‚°<br /><input type="text" id="taskTag" /></label><br />
      <label>æœŸé™<br /><input type="datetime-local" id="taskDue" /></label><br />
      <button type="submit">ä¿å­˜</button>
      <button type="button" id="cancelBtn" style="margin-left:1rem;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </form>
  </div>
</div>

<script>
(() => {
  let tasks = JSON.parse(localStorage.getItem("tasks")||"[]");
  let editingTaskIndex = null;
  let activeTag = null;

  const tabs = document.querySelectorAll(".tab-btn");
  const listView = document.getElementById("listView");
  const calendarView = document.getElementById("calendarView");
  const taskList = document.getElementById("taskList");
  const calendarDiv = document.getElementById("calendar");
  const addTaskBtn = document.getElementById("addTaskBtn");
  const taskModal = document.getElementById("taskModal");
  const taskForm = document.getElementById("taskForm");
  const taskTitleInput = document.getElementById("taskTitle");
  const taskTagInput = document.getElementById("taskTag");
  const taskDueInput = document.getElementById("taskDue");
  const cancelBtn = document.getElementById("cancelBtn");
  const tagFilters = document.getElementById("tagFilters");

  const colors = ["color-0","color-1","color-2","color-3"];
  const shapes = ["shape-0","shape-1","shape-2"];
  const fontSizes = ["1rem","1.2rem","1.5rem"];

  function saveTasks() {
    localStorage.setItem("tasks", JSON.stringify(tasks));
  }

  tabs.forEach(tab => {
    tab.addEventListener("click", () => {
      tabs.forEach(b => b.classList.remove("active"));
      tab.classList.add("active");
      if(tab.dataset.view === "list") {
        listView.style.display = "";
        calendarView.style.display = "none";
        renderTasks();
      } else {
        listView.style.display = "none";
        calendarView.style.display = "";
        renderCalendar();
      }
    });
  });

  addTaskBtn.addEventListener("click", () => {
    editingTaskIndex = null;
    taskTitleInput.value = "";
    taskTagInput.value = "";
    taskDueInput.value = "";
    taskModal.style.display = "flex";
  });

  cancelBtn.addEventListener("click", () => { taskModal.style.display = "none"; });

  taskForm.addEventListener("submit", e => {
    e.preventDefault();
    const newTask = {
      title: taskTitleInput.value,
      tag: taskTagInput.value,
      due: taskDueInput.value,
      done: false,
      color: 0,
      shape: 0,
      fontSize: 0
    };
    if(editingTaskIndex !== null) tasks[editingTaskIndex] = newTask;
    else tasks.push(newTask);
    saveTasks();
    scheduleNotification(newTask);
    taskModal.style.display = "none";
    renderTasks();
  });

  function scheduleNotification(task){
    if(!("Notification" in window)) return;
    Notification.requestPermission().then(perm => {
      if(perm !== "granted" || !task.due) return;
      const dueDate = new Date(task.due);
      const diff = dueDate.getTime() - Date.now() - 30*60*1000;
      if(diff > 0){
        setTimeout(() => {
          new Notification("ã‚¿ã‚¹ã‚¯ã®æ™‚é–“ã§ã™", { body: task.title });
        }, diff);
      }
    });
  }

  function renderTagFilters() {
    tagFilters.innerHTML = "";
    const tags = [...new Set(tasks.map(t => t.tag).filter(t => t))];
    const allBtn = document.createElement("button");
    allBtn.textContent = "ã™ã¹ã¦";
    allBtn.addEventListener("click", () => { activeTag = null; renderTasks(); });
    tagFilters.appendChild(allBtn);

    tags.forEach(tag => {
      const btn = document.createElement("button");
      btn.textContent = tag;
      btn.addEventListener("click", () => { activeTag = tag; renderTasks(); });
      tagFilters.appendChild(btn);
    });
  }

  function renderTasks() {
    renderTagFilters();
    taskList.innerHTML = "";
    tasks.filter(t => !activeTag || t.tag===activeTag).forEach((task,i) => {
      const card = document.createElement("div");
      card.className = `task-card ${colors[task.color]||colors[0]} ${shapes[task.shape]||shapes[0]}`;
      if(task.done) card.classList.add("done");
      card.style.fontSize = fontSizes[task.fontSize]||fontSizes[0];

      const checkbox = document.createElement("input");
      checkbox.type = "checkbox";
      checkbox.checked = task.done;
      checkbox.addEventListener("change", () => { tasks[i].done = checkbox.checked; saveTasks(); renderTasks(); });
      card.appendChild(checkbox);

      const title = document.createElement("div");
      title.className = "task-title";
      title.textContent = task.title;
      card.appendChild(title);

      if(task.tag){
        const tagEl = document.createElement("div");
        tagEl.className = "task-tag";
        tagEl.textContent = task.tag;
        card.appendChild(tagEl);
      }

      // --- â‹® ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¿½åŠ  ---
      const menuBtn = document.createElement("button");
      menuBtn.className = "menu-btn";
      menuBtn.textContent = "â‹®";
      card.appendChild(menuBtn);

      const menu = document.createElement("div");
      menu.className = "menu";
      menu.innerHTML = `
        <button class="font-small">æ–‡å­—ã‚µã‚¤ã‚º å°</button>
        <button class="font-medium">æ–‡å­—ã‚µã‚¤ã‚º ä¸­</button>
        <button class="font-large">æ–‡å­—ã‚µã‚¤ã‚º å¤§</button>
        <button class="shape-0">å½¢çŠ¶ è§’ä¸¸</button>
        <button class="shape-1">å½¢çŠ¶ è§’ã‚ã‚Š</button>
        <button class="shape-2">å½¢çŠ¶ å½±ã‚ã‚Š</button>
        <button class="delete-btn">ğŸ—‘ï¸ å‰Šé™¤</button>
      `;
      card.appendChild(menu);

      menuBtn.addEventListener("click", e => {
        e.stopPropagation();
        document.querySelectorAll(".menu").forEach(m => { if(m!==menu) m.classList.remove("visible"); });
        menu.classList.toggle("visible");
      });
      document.body.addEventListener("click", () => menu.classList.remove("visible"));

      menu.querySelector(".font-small").addEventListener("click", () => { tasks[i].fontSize = 0; saveTasks(); renderTasks(); });
      menu.querySelector(".font-medium").addEventListener("click", () => { tasks[i].fontSize = 1; saveTasks(); renderTasks(); });
      menu.querySelector(".font-large").addEventListener("click", () => { tasks[i].fontSize = 2; saveTasks(); renderTasks(); });
      menu.querySelector(".shape-0").addEventListener("click", () => { tasks[i].shape = 0; saveTasks(); renderTasks(); });
      menu.querySelector(".shape-1").addEventListener("click", () => { tasks[i].shape = 1; saveTasks(); renderTasks(); });
      menu.querySelector(".shape-2").addEventListener("click", () => { tasks[i].shape = 2; saveTasks(); renderTasks(); });
      menu.querySelector(".delete-btn").addEventListener("click", () => { tasks.splice(i,1); saveTasks(); renderTasks(); });

      // ã‚¹ãƒ¯ã‚¤ãƒ—ã§è‰²å¤‰æ›´
      let startX = null;
      card.addEventListener("touchstart", e => { startX = e.changedTouches[0].clientX; });
      card.addEventListener("touchend", e => {
        if(startX === null) return;
        let diff = e.changedTouches[0].clientX - startX;
        if(Math.abs(diff) > 30){
          let c = task.color || 0;
          tasks[i].color = diff > 0 ? (c+1)%colors.length : (c+colors.length-1)%colors.length;
          saveTasks(); renderTasks();
        }
        startX = null;
      });

      taskList.appendChild(card);
    });
  }

  function renderCalendar() {
    calendarDiv.innerHTML = "";
    const now = new Date();
    const year = now.getFullYear();
    const month = now.getMonth();
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const startWeekDay = firstDay.getDay();
    const totalDays = lastDay.getDate();
    const table = document.createElement("table");
    table.className = "calendar-table";
    const thead = document.createElement("thead");
    const trHead = document.createElement("tr");
    ["æ—¥","æœˆ","ç«","æ°´","æœ¨","é‡‘","åœŸ"].forEach(d => {
      const th = document.createElement("th"); th.textContent = d; trHead.appendChild(th);
    });
    thead.appendChild(trHead); table.appendChild(thead);
    const tbody = document.createElement("tbody");
    let dayCount = 1;
    for(let i=0; i<6; i++){
      const tr = document.createElement("tr");
      for(let j=0; j<7; j++){
        const td = document.createElement("td");
        if(i===0 && j < startWeekDay || dayCount > totalDays){ td.textContent = ""; }
        else {
          const dateDiv = document.createElement("div");
          dateDiv.className = "calendar-date"; dateDiv.textContent = dayCount;
          td.appendChild(dateDiv);
          const dayStr = `${year}-${String(month+1).padStart(2,"0")}-${String(dayCount).padStart(2,"0")}`;
          tasks.forEach(task => {
            if(task.due && task.due.startsWith(dayStr)){
              const taskDiv = document.createElement("div");
              taskDiv.className = "calendar-task";
              taskDiv.textContent = task.title;
              td.appendChild(taskDiv);
            }
          });
          dayCount++;
        }
        tr.appendChild(td);
      }
      tbody.appendChild(tr);
    }
    table.appendChild(tbody);
    calendarDiv.appendChild(table);
  }

  renderTasks();
})();
</script>
</body>
</html>